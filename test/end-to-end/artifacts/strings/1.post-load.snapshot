export 0 = &function run;

slot asciiTests = &function asciiTests;
slot ['global:assertEqual'] = host function 3;

function Array_push() {
  entry:
    LoadArg(index 1);
    LoadArg(index 0);
    LoadArg(index 0);
    Literal(lit 'length');
    ObjectGet();
    LoadVar(index 0);
    ObjectSet();
    Pop(count 1);
    Literal(lit undefined);
    Return();
}

function asciiTests() {
  entry:
    // ROM string
    LoadGlobal(name 'global:assertEqual');
    Literal(lit undefined);
    Literal(lit 'abc');
    Literal(lit 'length');
    ObjectGet();
    Literal(lit 3);
    Call(count 3);
    Pop(count 1);
    LoadGlobal(name 'global:assertEqual');
    Literal(lit undefined);
    Literal(lit 'abc');
    Literal(lit 0);
    ObjectGet();
    Literal(lit 'a');
    Call(count 3);
    Pop(count 1);
    LoadGlobal(name 'global:assertEqual');
    Literal(lit undefined);
    Literal(lit 'abc');
    Literal(lit 2);
    ObjectGet();
    Literal(lit 'c');
    Call(count 3);
    Pop(count 1);
    LoadGlobal(name 'global:assertEqual');
    Literal(lit undefined);
    Literal(lit 'abc');
    Literal(lit 3);
    ObjectGet();
    Literal(lit undefined);
    Call(count 3);
    Pop(count 1);
    // RAM string (constructed)
    LoadGlobal(name 'global:assertEqual');
    Literal(lit undefined);
    Literal(lit 'a');
    Literal(lit 'bc');
    BinOp(op '+');
    Literal(lit 'length');
    ObjectGet();
    Literal(lit 3);
    Call(count 3);
    Pop(count 1);
    LoadGlobal(name 'global:assertEqual');
    Literal(lit undefined);
    Literal(lit 'a');
    Literal(lit 'bc');
    BinOp(op '+');
    Literal(lit 0);
    ObjectGet();
    Literal(lit 'a');
    Call(count 3);
    Pop(count 1);
    LoadGlobal(name 'global:assertEqual');
    Literal(lit undefined);
    Literal(lit 'a');
    Literal(lit 'bc');
    BinOp(op '+');
    Literal(lit 2);
    ObjectGet();
    Literal(lit 'c');
    Call(count 3);
    Pop(count 1);
    LoadGlobal(name 'global:assertEqual');
    Literal(lit undefined);
    Literal(lit 'a');
    Literal(lit 'bc');
    BinOp(op '+');
    Literal(lit 3);
    ObjectGet();
    Literal(lit undefined);
    Call(count 3);
    Pop(count 1);
    // Special strings
    LoadGlobal(name 'global:assertEqual');
    Literal(lit undefined);
    Literal(lit 'length');
    Literal(lit 'length');
    ObjectGet();
    Literal(lit 6);
    Call(count 3);
    Pop(count 1);
    LoadGlobal(name 'global:assertEqual');
    Literal(lit undefined);
    Literal(lit '__proto__');
    Literal(lit 'length');
    ObjectGet();
    Literal(lit 9);
    Call(count 3);
    Pop(count 1);
    LoadGlobal(name 'global:assertEqual');
    Literal(lit undefined);
    Literal(lit 'length');
    Literal(lit 0);
    ObjectGet();
    Literal(lit 'l');
    Call(count 3);
    Pop(count 1);
    LoadGlobal(name 'global:assertEqual');
    Literal(lit undefined);
    Literal(lit 'length');
    Literal(lit 5);
    ObjectGet();
    Literal(lit 'h');
    Call(count 3);
    Pop(count 1);
    LoadGlobal(name 'global:assertEqual');
    Literal(lit undefined);
    Literal(lit 'length');
    Literal(lit 6);
    ObjectGet();
    Literal(lit undefined);
    Call(count 3);
    Pop(count 1);
    LoadGlobal(name 'global:assertEqual');
    Literal(lit undefined);
    Literal(lit '__proto__');
    Literal(lit 0);
    ObjectGet();
    Literal(lit '_');
    Call(count 3);
    Pop(count 1);
    LoadGlobal(name 'global:assertEqual');
    Literal(lit undefined);
    Literal(lit '__proto__');
    Literal(lit 8);
    ObjectGet();
    Literal(lit '_');
    Call(count 3);
    Pop(count 1);
    LoadGlobal(name 'global:assertEqual');
    Literal(lit undefined);
    Literal(lit '__proto__');
    Literal(lit 9);
    ObjectGet();
    Literal(lit undefined);
    Call(count 3);
    Pop(count 1);
    Literal(lit undefined);
    Return();
}

function run() {
  entry:
    LoadGlobal(name 'global:assertEqual');
    Literal(lit undefined);
    Literal(lit 'abc');
    Literal(lit 'abc');
    Call(count 3);
    Pop(count 1);
    LoadGlobal(name 'global:assertEqual');
    Literal(lit undefined);
    Literal(lit 'ab_');
    Literal(lit 'cd');
    BinOp(op '+');
    Literal(lit 'ab_cd');
    Call(count 3);
    Pop(count 1);
    LoadGlobal(name 'global:assertEqual');
    Literal(lit undefined);
    Literal(lit 'ab_');
    Literal(lit 'cd');
    BinOp(op '+');
    Literal(lit 'ef');
    BinOp(op '+');
    Literal(lit 'ab_cdef');
    Call(count 3);
    Pop(count 1);
    // Int14
    LoadGlobal(name 'global:assertEqual');
    Literal(lit undefined);
    Literal(lit 'ab_');
    Literal(lit 5);
    BinOp(op '+');
    Literal(lit 'ab_5');
    Call(count 3);
    Pop(count 1);
    // Negative
    LoadGlobal(name 'global:assertEqual');
    Literal(lit undefined);
    Literal(lit 'ab_');
    Literal(lit -5);
    BinOp(op '+');
    Literal(lit 'ab_-5');
    Call(count 3);
    Pop(count 1);
    // Int32
    LoadGlobal(name 'global:assertEqual');
    Literal(lit undefined);
    Literal(lit 'ab_');
    Literal(lit 500000);
    BinOp(op '+');
    Literal(lit 'ab_500000');
    Call(count 3);
    Pop(count 1);
    LoadGlobal(name 'global:assertEqual');
    Literal(lit undefined);
    Literal(lit 'ab_');
    Literal(lit -500000);
    BinOp(op '+');
    Literal(lit 'ab_-500000');
    Call(count 3);
    Pop(count 1);
    LoadGlobal(name 'global:assertEqual');
    Literal(lit undefined);
    Literal(lit 'ab_');
    Literal(lit -2147483648);
    BinOp(op '+');
    Literal(lit 'ab_-2147483648');
    Call(count 3);
    Pop(count 1);
    // Some general constants
    LoadGlobal(name 'global:assertEqual');
    Literal(lit undefined);
    Literal(lit 'ab_');
    Literal(lit null);
    BinOp(op '+');
    Literal(lit 'ab_null');
    Call(count 3);
    Pop(count 1);
    LoadGlobal(name 'global:assertEqual');
    Literal(lit undefined);
    Literal(lit 'ab_');
    Literal(lit true);
    BinOp(op '+');
    Literal(lit 'ab_true');
    Call(count 3);
    Pop(count 1);
    LoadGlobal(name 'global:assertEqual');
    Literal(lit undefined);
    Literal(lit 'ab_');
    Literal(lit false);
    BinOp(op '+');
    Literal(lit 'ab_false');
    Call(count 3);
    Pop(count 1);
    LoadGlobal(name 'global:assertEqual');
    Literal(lit undefined);
    Literal(lit 'ab_');
    Literal(lit undefined);
    BinOp(op '+');
    Literal(lit 'ab_undefined');
    Call(count 3);
    Pop(count 1);
    LoadGlobal(name 'global:assertEqual');
    Literal(lit undefined);
    Literal(lit 'ab_');
    Literal(lit -0);
    BinOp(op '+');
    Literal(lit 'ab_0');
    Call(count 3);
    Pop(count 1);
    // Special strings
    LoadGlobal(name 'global:assertEqual');
    Literal(lit undefined);
    Literal(lit 'ab_');
    Literal(lit 'proto');
    BinOp(op '+');
    Literal(lit 'ab_proto');
    Call(count 3);
    Pop(count 1);
    LoadGlobal(name 'global:assertEqual');
    Literal(lit undefined);
    Literal(lit 'proto');
    Literal(lit '_bc');
    BinOp(op '+');
    Literal(lit 'proto_bc');
    Call(count 3);
    Pop(count 1);
    LoadGlobal(name 'global:assertEqual');
    Literal(lit undefined);
    Literal(lit 'ab_');
    Literal(lit 'length');
    BinOp(op '+');
    Literal(lit 'ab_length');
    Call(count 3);
    Pop(count 1);
    LoadGlobal(name 'global:assertEqual');
    Literal(lit undefined);
    Literal(lit 'length');
    Literal(lit '_bc');
    BinOp(op '+');
    Literal(lit 'length_bc');
    Call(count 3);
    Pop(count 1);
    // Interpolation
    LoadGlobal(name 'global:assertEqual');
    Literal(lit undefined);
    Literal(lit '');
    Literal(lit '');
    Call(count 3);
    Pop(count 1);
    LoadGlobal(name 'global:assertEqual');
    Literal(lit undefined);
    Literal(lit 'abc');
    Literal(lit 'abc');
    Call(count 3);
    Pop(count 1);
    LoadGlobal(name 'global:assertEqual');
    Literal(lit undefined);
    Literal(lit '');
    Literal(lit '_');
    BinOp(op '+');
    Literal(lit 'abc');
    BinOp(op '+');
    Literal(lit '_abc');
    Call(count 3);
    Pop(count 1);
    LoadGlobal(name 'global:assertEqual');
    Literal(lit undefined);
    Literal(lit 'abc');
    Literal(lit '_');
    BinOp(op '+');
    Literal(lit 'abc_');
    Call(count 3);
    Pop(count 1);
    LoadGlobal(name 'global:assertEqual');
    Literal(lit undefined);
    Literal(lit 'ab');
    Literal(lit 5);
    BinOp(op '+');
    Literal(lit 'c');
    BinOp(op '+');
    Literal(lit 'ab5c');
    Call(count 3);
    Pop(count 1);
    // TODO: Strings as properties (interning)
    // TODO: Strings in RAM vs ROM
    // TODO: check interning for `obj['len' + 'th']
    LoadGlobal(name 'asciiTests');
    Literal(lit undefined);
    Call(count 1);
    Pop(count 1);
    Literal(lit undefined);
    Return();
}

allocation 5 = {
  push: &function Array_push,
};